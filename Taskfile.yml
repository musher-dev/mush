# Mush CLI Taskfile
# Usage: task [task-name]
# List tasks: task --list
#
# This Taskfile can be used standalone (from this directory) or via the root
# Taskfile with namespace: task mush:[task-name]

version: '3'

vars:
  BINARY: mush
  MODULE: github.com/musher-dev/mush

tasks:
  # ===========================================================================
  # Setup
  # ===========================================================================

  setup:
    desc: Install dependencies and tools
    cmds:
      - go mod download
      - task: setup:tools

  setup:tools:
    desc: Install required tooling
    cmds:
      - go install golang.org/x/vuln/cmd/govulncheck
      - go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint
      - go install mvdan.cc/sh/v3/cmd/shfmt
      - go install github.com/rhysd/actionlint/cmd/actionlint
      - go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen
      - 'command -v shellcheck >/dev/null 2>&1 || echo "Note: shellcheck is not installed. Install it via your OS package manager."'
      - 'command -v vhs >/dev/null 2>&1 || echo "Note: vhs is optional and only required for demo GIF generation."'

  # ===========================================================================
  # Development
  # ===========================================================================

  build:
    desc: Build the mush binary
    cmds:
      - go build -o {{.BINARY}} ./cmd/mush

  build:all:
    desc: Build for all platforms
    cmds:
      - GOOS=darwin GOARCH=amd64 go build -o {{.BINARY}}-darwin-amd64 ./cmd/mush
      - GOOS=darwin GOARCH=arm64 go build -o {{.BINARY}}-darwin-arm64 ./cmd/mush
      - GOOS=linux GOARCH=amd64 go build -o {{.BINARY}}-linux-amd64 ./cmd/mush
      - GOOS=linux GOARCH=arm64 go build -o {{.BINARY}}-linux-arm64 ./cmd/mush
      - GOOS=windows GOARCH=amd64 go build -o {{.BINARY}}-windows-amd64.exe ./cmd/mush

  run:
    desc: Run mush with arguments
    cmds:
      - go run ./cmd/mush {{.CLI_ARGS}}

  # ===========================================================================
  # Code Generation
  # ===========================================================================

  generate:
    desc: Generate API client from OpenAPI spec
    preconditions:
      - sh: command -v oapi-codegen >/dev/null 2>&1
        msg: "oapi-codegen is required. Run 'task setup:tools' first."
    cmds:
      - scripts/generate-client.sh

  # ===========================================================================
  # Demo / VHS
  # ===========================================================================

  vhs:
    desc: Generate demo GIFs from VHS tape files
    deps: [build]
    cmds:
      - vhs docs/vhs/demo.tape

  vhs:validate:
    desc: Validate VHS tape file syntax
    cmds:
      - vhs validate docs/vhs/*.tape

  # ===========================================================================
  # Code Quality
  # ===========================================================================

  check:
    desc: Run all checks (fmt + mod + lint + vuln + shell + workflows + errorf + prompt-fd + no-exit + output-context + force-noinput + testutil-prod + test + install)
    cmds:
      - task: check:fmt
      - task: check:mod
      - task: check:lint
      - task: check:vuln
      - task: check:shell
      - task: check:workflow
      - task: check:errorf
      - task: check:prompt-fd
      - task: check:no-exit
      - task: check:output-context
      - task: check:force-noinput
      - task: check:testutil-prod
      - task: check:test
      - task: check:install

  check:ci:
    desc: Run CI checks without duplicate test execution (uses coverage test pass)
    cmds:
      - task: check:fmt
      - task: check:mod
      - task: check:lint
      - task: check:vuln
      - task: check:shell
      - task: check:workflow
      - task: check:errorf
      - task: check:prompt-fd
      - task: check:no-exit
      - task: check:output-context
      - task: check:force-noinput
      - task: check:testutil-prod
      - task: check:test-cover
      - task: check:compile

  check:compile:
    desc: Verify cross-platform compilation for all release targets
    cmds:
      - GOOS=darwin  GOARCH=amd64 go build ./cmd/mush
      - GOOS=darwin  GOARCH=arm64 go build ./cmd/mush
      - GOOS=linux   GOARCH=amd64 go build ./cmd/mush
      - GOOS=linux   GOARCH=arm64 go build ./cmd/mush
      - GOOS=windows GOARCH=amd64 go build ./cmd/mush

  # Quick aliases for common operations
  test:
    desc: Run tests (alias for check:test)
    cmds:
      - task: check:test

  lint:
    desc: Run linter (alias for check:lint)
    cmds:
      - task: check:lint

  check:shell:
    desc: Lint shell scripts with shellcheck and shfmt
    preconditions:
      - sh: command -v shellcheck >/dev/null 2>&1
        msg: "shellcheck is required. Install it and retry."
      - sh: command -v shfmt >/dev/null 2>&1
        msg: "shfmt is required. Run 'task setup:tools' first."
    cmds:
      - shellcheck install.sh .devcontainer/scripts/*.sh scripts/*.sh .githooks/* .githooks/*.sh
      - shfmt -d -i 2 -ci install.sh .devcontainer/scripts/*.sh scripts/*.sh .githooks/* .githooks/*.sh

  check:workflow:
    desc: Lint GitHub Actions workflows with actionlint
    preconditions:
      - sh: command -v actionlint >/dev/null 2>&1
        msg: "actionlint is required. Run 'task setup:tools' first."
    cmds:
      - actionlint -color

  check:install:
    desc: Run install script integration tests
    cmds:
      - go test -v -count=1 ./test/install/...

  check:fmt:
    desc: Check Go formatting and imports (gofumpt + goimports)
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is required. Run 'task setup:tools' first."
    cmds:
      - golangci-lint fmt --diff ./...

  check:fmt:files:
    desc: Check Go formatting and imports for specific files
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is required. Run 'task setup:tools' first."
      - sh: test -n "{{.CLI_ARGS}}"
        msg: "Provide file paths via: task check:fmt:files -- <files...>"
    cmds:
      - golangci-lint fmt --diff {{.CLI_ARGS}}

  check:mod:
    desc: Verify module files are tidy
    cmds:
      - go mod tidy -diff

  check:lint:
    desc: Run golangci-lint v2 (strict)
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is required. Run 'task setup:tools' first."
    cmds:
      - golangci-lint run ./...

  check:lint:files:
    desc: Run golangci-lint for specific files/packages
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is required. Run 'task setup:tools' first."
      - sh: test -n "{{.CLI_ARGS}}"
        msg: "Provide targets via: task check:lint:files -- <files...>"
    cmds:
      - golangci-lint run {{.CLI_ARGS}}

  check:vuln:
    desc: Run govulncheck
    preconditions:
      - sh: command -v govulncheck >/dev/null 2>&1
        msg: "govulncheck is required. Run 'task setup:tools' first."
    cmds:
      - govulncheck ./...

  check:errorf:
    desc: Ensure no raw fmt.Errorf in cmd/mush (use CLIError instead)
    cmds:
      - |
        hits=$(grep -rn 'fmt\.Errorf' cmd/mush/*.go | grep -v '_test\.go' | grep -v 'nolint:rawerror' || true)
        if [ -n "$hits" ]; then
          echo "ERROR: Raw fmt.Errorf found in cmd/mush/ — use clierrors.Wrap or clierrors.New instead:"
          echo "$hits"
          exit 1
        fi

  check:prompt-fd:
    desc: Ensure prompt package checks stdin fd, not stdout fd
    cmds:
      - |
        hits=$(grep -rn 'os\.Stdout\.Fd()' internal/prompt/*.go || true)
        if [ -n "$hits" ]; then
          echo "ERROR: os.Stdout.Fd() found in internal/prompt/ — use os.Stdin.Fd() for TTY checks:"
          echo "$hits"
          exit 1
        fi

  check:no-exit:
    desc: Ensure no os.Exit() in cmd/mush/ except main.go
    cmds:
      - |
        hits=$(grep -rn 'os\.Exit(' cmd/mush/*.go | grep -v 'main\.go' | grep -v '_test\.go' || true)
        if [ -n "$hits" ]; then
          echo "ERROR: os.Exit() found outside main.go — return CLIError instead:"
          echo "$hits"
          exit 1
        fi

  check:output-context:
    desc: Ensure no output.Default() in cmd/mush/ except main.go
    cmds:
      - |
        hits=$(grep -rn 'output\.Default()' cmd/mush/*.go | grep -v 'main\.go' | grep -v '_test\.go' || true)
        if [ -n "$hits" ]; then
          echo "ERROR: output.Default() found outside main.go — use output.FromContext(cmd.Context()) instead:"
          echo "$hits"
          exit 1
        fi

  check:force-noinput:
    desc: Ensure files using Confirm() also reference NoInput
    cmds:
      - |
        failed=0
        for f in $(grep -rl '\.Confirm(' cmd/mush/*.go | grep -v '_test\.go'); do
          if ! grep -q 'NoInput' "$f"; then
            echo "ERROR: $f uses Confirm() but does not reference NoInput"
            failed=1
          fi
        done
        if [ "$failed" -eq 1 ]; then
          echo "Files using Confirm() must check NoInput and return a CLIError with --force hint."
          exit 1
        fi

  check:testutil-prod:
    desc: Ensure testutil is not imported by production code
    cmds:
      - |
        hits=$(grep -rn 'musher-dev/mush/internal/testutil' --include='*.go' . | grep -v '_test\.go' || true)
        if [ -n "$hits" ]; then
          echo "ERROR: internal/testutil imported by production code:"
          echo "$hits"
          exit 1
        fi

  check:test:
    desc: Run tests with race detection
    cmds:
      - go test -v -race ./...

  check:test:packages:
    desc: Run tests with race detection for specific packages
    preconditions:
      - sh: test -n "{{.CLI_ARGS}}"
        msg: "Provide package paths via: task check:test:packages -- <packages...>"
    cmds:
      - go test -v -race {{.CLI_ARGS}}

  check:test-cover:
    desc: Run tests with coverage
    cmds:
      - go test -v -race -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html

  check:shell:files:
    desc: Lint specific shell files with shellcheck and shfmt
    preconditions:
      - sh: command -v shellcheck >/dev/null 2>&1
        msg: "shellcheck is required. Install it and retry."
      - sh: command -v shfmt >/dev/null 2>&1
        msg: "shfmt is required. Run 'task setup:tools' first."
      - sh: test -n "{{.CLI_ARGS}}"
        msg: "Provide shell files via: task check:shell:files -- <files...>"
    cmds:
      - shellcheck {{.CLI_ARGS}}
      - shfmt -d -i 2 -ci {{.CLI_ARGS}}

  check:workflow:files:
    desc: Lint specific GitHub Actions workflow files with actionlint
    preconditions:
      - sh: command -v actionlint >/dev/null 2>&1
        msg: "actionlint is required. Run 'task setup:tools' first."
      - sh: test -n "{{.CLI_ARGS}}"
        msg: "Provide workflow files via: task check:workflow:files -- <files...>"
    cmds:
      - actionlint -color {{.CLI_ARGS}}

  # ===========================================================================
  # Formatting
  # ===========================================================================

  fmt:
    desc: Format Go code and imports
    preconditions:
      - sh: command -v golangci-lint >/dev/null 2>&1
        msg: "golangci-lint is required. Run 'task setup:tools' first."
    cmds:
      - golangci-lint fmt ./...
      - go mod tidy

  # ===========================================================================
  # Golden File Testing
  # ===========================================================================

  test:update-golden:
    desc: Update golden files
    cmds:
      - UPDATE_GOLDEN=1 go test ./...

  # ===========================================================================
  # Git Hooks
  # ===========================================================================

  hooks:install:
    desc: Install repository git hooks via core.hooksPath
    cmds:
      - test -d .githooks || (echo ".githooks directory not found" && exit 1)
      - chmod +x .githooks/*
      - git config core.hooksPath .githooks
      - task: hooks:doctor

  hooks:doctor:
    desc: Verify git hook installation and required tools
    cmds:
      - |
        test "$(git config --get core.hooksPath || true)" = ".githooks" || \
          (echo "core.hooksPath is not set to .githooks (run: task hooks:install)" && exit 1)
      - test -x .githooks/pre-commit || (echo "missing executable .githooks/pre-commit" && exit 1)
      - test -x .githooks/commit-msg || (echo "missing executable .githooks/commit-msg" && exit 1)
      - test -x .githooks/pre-push || (echo "missing executable .githooks/pre-push" && exit 1)
      - test -x .githooks/run-pre-commit.sh || (echo "missing executable .githooks/run-pre-commit.sh" && exit 1)
      - test -x .githooks/run-commit-msg.sh || (echo "missing executable .githooks/run-commit-msg.sh" && exit 1)
      - test -x .githooks/run-pre-push.sh || (echo "missing executable .githooks/run-pre-push.sh" && exit 1)
      - 'command -v task >/dev/null 2>&1 || (echo "task is required" && exit 1)'
      - 'command -v git >/dev/null 2>&1 || (echo "git is required" && exit 1)'
      - 'command -v golangci-lint >/dev/null 2>&1 || (echo "golangci-lint is required (run: task setup:tools)" && exit 1)'
      - 'command -v govulncheck >/dev/null 2>&1 || (echo "govulncheck is required (run: task setup:tools)" && exit 1)'
      - 'command -v shfmt >/dev/null 2>&1 || (echo "shfmt is required (run: task setup:tools)" && exit 1)'
      - 'command -v actionlint >/dev/null 2>&1 || (echo "actionlint is required (run: task setup:tools)" && exit 1)'
      - 'command -v shellcheck >/dev/null 2>&1 || (echo "shellcheck is required (install via OS package manager)" && exit 1)'

  hooks:uninstall:
    desc: Remove repository hook path override
    cmds:
      - git config --unset core.hooksPath || true

  hooks:pre-commit:
    desc: Run pre-commit hook checks
    cmds:
      - .githooks/run-pre-commit.sh

  hooks:commit-msg:
    desc: Run commit-msg hook checks
    preconditions:
      - sh: test -n "${COMMIT_MSG_FILE:-}"
        msg: "COMMIT_MSG_FILE is required"
    cmds:
      - .githooks/run-commit-msg.sh "${COMMIT_MSG_FILE}"

  hooks:pre-push:
    desc: Run pre-push hook checks
    preconditions:
      - sh: test -n "${PRE_PUSH_STDIN_FILE:-}"
        msg: "PRE_PUSH_STDIN_FILE is required"
    cmds:
      - .githooks/run-pre-push.sh "${PRE_PUSH_REMOTE_NAME:-}" "${PRE_PUSH_REMOTE_URL:-}" "${PRE_PUSH_STDIN_FILE}"

  # ===========================================================================
  # Utilities
  # ===========================================================================

  clean:
    desc: Clean build artifacts
    cmds:
      - rm -f {{.BINARY}} {{.BINARY}}-*
      - rm -f coverage.out coverage.html
      - rm -f docs/vhs/gif/*.gif

  version:
    desc: Show version info
    cmds:
      - go run ./cmd/mush version

  help:
    desc: Show mush help
    cmds:
      - go run ./cmd/mush --help
